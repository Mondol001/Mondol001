<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro Expense Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    .expense-card { transition: all 0.3s; }
    .expense-card:hover { transform: translateY(-5px); }
    .cursor-pointer { cursor: pointer; }
    .dark-mode { background: #1a1a1a; color: white; }
    .chart-container { height: 400px; }
    .preview-image { max-width: 100px; max-height: 100px; }
    [data-bs-theme=dark] .card { background-color: #2d2d2d; }
  </style>
</head>
<body class="container-fluid">
  <!-- Toast Container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  <!-- Main Header -->
  <header class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
    <h1 class="h2"><i class="bi bi-wallet2"></i> Pro Expense Manager</h1>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary" onclick="toggleTheme()"><i class="bi bi-moon"></i></button>
      <button class="btn btn-sm btn-danger" onclick="showBackupModal()"><i class="bi bi-cloud-arrow-up"></i> Backup</button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="row g-4">
    <!-- Input Section -->
    <div class="col-lg-4">
      <div class="card expense-card">
        <div class="card-body">
          <form id="expenseForm" novalidate>
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control" id="date" required>
              <div class="invalid-feedback">Please select a date</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" id="category" required>
                <option value="">Select Category</option>
                <option value="Food">Food</option>
                <option value="Transport">Transport</option>
                <option value="Housing">Housing</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Education">Education</option>
                <option value="Other">Other</option>
              </select>
              <div class="invalid-feedback">Please select a category</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Item Name</label>
              <input type="text" class="form-control" id="item" required>
              <div class="invalid-feedback">Please enter item name</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Amount</label>
              <div class="input-group">
                <select class="form-select w-25" id="currency">
                  <option value="USD">$</option>
                  <option value="EUR">€</option>
                  <option value="BDT">৳</option>
                  <option value="INR">₹</option>
                </select>
                <input type="number" class="form-control" id="amount" step="0.01" required>
                <div class="invalid-feedback">Please enter amount</div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Tags</label>
              <input type="text" class="form-control" id="tags" placeholder="e.g. urgent, business">
            </div>

            <div class="mb-3">
              <label class="form-label">Attachment</label>
              <input type="file" class="form-control" id="attachment" accept="image/*">
              <img src="" class="preview-image mt-2 d-none" alt="Preview">
            </div>

            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" id="notes" rows="2"></textarea>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-plus-circle"></i> Add Expense
              </button>
              <button type="button" class="btn btn-secondary d-none" onclick="cancelEdit()" id="cancelBtn">
                <i class="bi bi-x-circle"></i> Cancel Edit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Data Section -->
    <div class="col-lg-8">
      <div class="card expense-card">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-4">
            <div class="input-group w-50">
              <input type="text" class="form-control" placeholder="Search expenses..." id="searchInput">
              <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
            </div>
            <select class="form-select w-25" id="reportType">
              <option value="daily">Daily Report</option>
              <option value="weekly">Weekly Report</option>
              <option value="monthly">Monthly Report</option>
              <option value="yearly">Yearly Report</option>
            </select>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th class="cursor-pointer" onclick="sortTable('date')">Date <i class="bi bi-arrow-down"></i></th>
                  <th class="cursor-pointer" onclick="sortTable('category')">Category</th>
                  <th>Item</th>
                  <th class="cursor-pointer" onclick="sortTable('amount')">Amount</th>
                  <th>Tags</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="expenseTableBody"></tbody>
            </table>
          </div>

          <div class="chart-container mt-4">
            <canvas id="analyticsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Backup Modal -->
  <div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Data Management</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <button class="btn btn-outline-primary w-100" onclick="exportData('json')">
              <i class="bi bi-file-earmark-arrow-down"></i> Export as JSON
            </button>
          </div>
          <div class="mb-3">
            <button class="btn btn-outline-success w-100" onclick="exportData('csv')">
              <i class="bi bi-file-earmark-spreadsheet"></i> Export as CSV
            </button>
          </div>
          <div class="mb-3">
            <input type="file" class="form-control" id="restoreFile" accept=".json,.csv">
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const ExpenseManager = (() => {
  let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
  let editIndex = -1;
  let lastDeleted = null;
  let currentSort = { column: 'date', ascending: false };
  let chartInstance = null;

  // Initialize
  const init = () => {
    document.getElementById('searchInput').addEventListener('input', renderTable);
    document.getElementById('reportType').addEventListener('change', renderChart);
    document.getElementById('restoreFile').addEventListener('change', handleFileImport);
    document.addEventListener('keydown', handleKeyboardShortcuts);
    renderAll();
  };

  // Form Handling
  const handleSubmit = (e) => {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    const expense = {
      id: Date.now(),
      date: document.getElementById('date').value,
      category: document.getElementById('category').value,
      item: document.getElementById('item').value,
      amount: parseFloat(document.getElementById('amount').value).toFixed(2),
      currency: document.getElementById('currency').value,
      tags: document.getElementById('tags').value.split(',').map(t => t.trim()),
      notes: document.getElementById('notes').value,
      attachment: document.querySelector('.preview-image').src || '',
      createdAt: DateTime.now().toISO()
    };

    if (editIndex === -1) {
      expenses.push(expense);
      showToast('Expense added successfully!', 'success');
    } else {
      expenses[editIndex] = expense;
      showToast('Expense updated successfully!', 'success');
      editIndex = -1;
    }

    resetForm();
    renderAll();
  };

  // Edit Expense
  const editExpense = (id) => {
    const index = expenses.findIndex(e => e.id === id);
    const expense = expenses[index];
    
    document.getElementById('date').value = expense.date;
    document.getElementById('category').value = expense.category;
    document.getElementById('item').value = expense.item;
    document.getElementById('amount').value = expense.amount;
    document.getElementById('currency').value = expense.currency;
    document.getElementById('tags').value = expense.tags.join(', ');
    document.getElementById('notes').value = expense.notes;
    
    const preview = document.querySelector('.preview-image');
    preview.src = expense.attachment;
    preview.classList.toggle('d-none', !expense.attachment);

    editIndex = index;
    document.getElementById('submitBtn').innerHTML = '<i class="bi bi-pencil-square"></i> Update Expense';
    document.getElementById('cancelBtn').classList.remove('d-none');
  };

  // Delete Expense
  const deleteExpense = (id) => {
    const index = expenses.findIndex(e => e.id === id);
    lastDeleted = expenses.splice(index, 1)[0];
    showToast('Expense deleted. <button class="btn btn-sm btn-link" onclick="ExpenseManager.undoDelete()">Undo</button>', 'warning');
    renderAll();
  };

  // Undo Delete
  const undoDelete = () => {
    if (lastDeleted) {
      expenses.push(lastDeleted);
      lastDeleted = null;
      renderAll();
      showToast('Expense restored successfully!', 'success');
    }
  };

  // File Handling
  const handleFileImport = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        expenses = data;
        renderAll();
        showToast('Data imported successfully!', 'success');
      } catch {
        showToast('Invalid file format!', 'danger');
      }
    };
    
    reader.readAsText(file);
  };

  // Chart Rendering
  const renderChart = () => {
    const ctx = document.getElementById('analyticsChart');
    if (chartInstance) chartInstance.destroy();

    // Chart configuration
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: getChartData(),
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'Expense Analytics' }
        }
      }
    });
  };

  // Table Sorting
  const sortTable = (column) => {
    if (currentSort.column === column) {
      currentSort.ascending = !currentSort.ascending;
    } else {
      currentSort = { column, ascending: true };
    }
    renderTable();
  };

  // Utility Methods
  const resetForm = () => {
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseForm').classList.remove('was-validated');
    document.querySelector('.preview-image').src = '';
    document.querySelector('.preview-image').classList.add('d-none');
    document.getElementById('submitBtn').innerHTML = '<i class="bi bi-plus-circle"></i> Add Expense';
    document.getElementById('cancelBtn').classList.add('d-none');
    editIndex = -1;
  };

  const renderAll = () => {
    renderTable();
    renderChart();
    localStorage.setItem('expenses', JSON.stringify(expenses));
  };

  return {
    init,
    handleSubmit,
    editExpense,
    deleteExpense,
    undoDelete,
    sortTable
  };
})();

// Initialize App
document.addEventListener('DOMContentLoaded', () => {
  ExpenseManager.init();
  document.getElementById('expenseForm').addEventListener('submit', ExpenseManager.handleSubmit);
});

// Additional Helper Functions
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0`;
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  document.querySelector('.toast-container').appendChild(toast);
  new bootstrap.Toast(toast).show();
}

function toggleTheme() {
  const html = document.documentElement;
  html.setAttribute('data-bs-theme', 
    html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'
  );
}

function showBackupModal() {
  new bootstrap.Modal('#backupModal').show();
}

// Image Preview Handler
document.getElementById('attachment').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const preview = document.querySelector('.preview-image');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = (event) => {
      preview.src = event.target.result;
      preview.classList.remove('d-none');
    };
    reader.readAsDataURL(file);
  }
});

// Keyboard Shortcuts
function handleKeyboardShortcuts(e) {
  if (e.ctrlKey && e.key === 'z') {
    ExpenseManager.undoDelete();
  }
  if (e.key === 'Escape') {
    cancelEdit();
  }
}

// Export Functions
function exportData(type) {
  // ... existing export logic with enhancements ...
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Expense Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      max-width: 600px;
      margin: 20px auto;
    }
    .export-buttons {
      margin: 20px 0;
    }
    .amount-positive {
      color: green;
    }
    .amount-negative {
      color: red;
    }
  </style>
</head>
<body class="container mt-5">
  <h1 class="text-center mb-4">Advanced Expense Tracker</h1>

  <div class="card mb-4">
    <div class="card-body">
      <form id="expenseForm">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="date" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Category</label>
            <select class="form-select" id="category" required>
              <option value="">Select Category</option>
              <option value="Food">Food</option>
              <option value="Transport">Transport</option>
              <option value="Housing">Housing</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" id="item" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount</label>
            <div class="input-group">
              <span class="input-group-text">₹</span>
              <input type="number" class="form-control" id="amount" step="0.01" required>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="notes" rows="2"></textarea>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary" id="submitBtn">Add Expense</button>
            <button type="button" class="btn btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display: none;">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Filter by Date Range</label>
      <input type="date" class="form-control" id="startDate">
    </div>
    <div class="col-md-4">
      <label class="form-label">To</label>
      <input type="date" class="form-control" id="endDate">
    </div>
    <div class="col-md-4">
      <label class="form-label">Filter by Category</label>
      <select class="form-select" id="filterCategory">
        <option value="all">All Categories</option>
      </select>
    </div>
  </div>

  <div class="export-buttons">
    <button class="btn btn-outline-success" onclick="exportData('json')">Export as JSON</button>
    <button class="btn btn-outline-info" onclick="exportData('csv')">Export as CSV</button>
  </div>

  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Item</th>
        <th>Amount</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="expenseTableBody"></tbody>
  </table>

  <div class="chart-container">
    <canvas id="expenseChart"></canvas>
  </div>

  <script>
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    let editIndex = -1;
    let expenseChart = null;

    // Initialize Chart
    function initChart() {
      const ctx = document.getElementById('expenseChart').getContext('2d');
      if (expenseChart) expenseChart.destroy();
      
      const categories = [...new Set(expenses.map(e => e.category))];
      const amounts = categories.map(cat => 
        expenses.filter(e => e.category === cat).reduce((sum, e) => sum + parseFloat(e.amount), 0)
      );

      expenseChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: categories,
          datasets: [{
            data: amounts,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Expense Distribution by Category' }
          }
        }
      });
    }

    // Render Expenses
    function renderExpenses() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const category = document.getElementById('filterCategory').value;

      let filtered = expenses.filter(e => {
        const dateMatch = (!startDate || e.date >= startDate) && (!endDate || e.date <= endDate);
        const categoryMatch = category === 'all' || e.category === category;
        return dateMatch && categoryMatch;
      });

      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = filtered.map((expense, index) => `
        <tr>
          <td>${new Date(expense.date).toLocaleDateString()}</td>
          <td>${expense.category}</td>
          <td>${expense.item}</td>
          <td class="${expense.amount < 0 ? 'amount-negative' : 'amount-positive'}">
            ₹${parseFloat(expense.amount).toFixed(2)}
          </td>
          <td>${expense.notes}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editExpense(${index})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="confirmDelete(${index})">Delete</button>
          </td>
        </tr>
      `).join('');

      updateCategoryFilter();
      localStorage.setItem('expenses', JSON.stringify(expenses));
      initChart();
    }

    // Update Category Filter Options
    function updateCategoryFilter() {
      const categories = ['all', ...new Set(expenses.map(e => e.category))];
      const select = document.getElementById('filterCategory');
      select.innerHTML = categories.map(cat => 
        `<option value="${cat}">${cat}</option>`
      ).join('');
    }

    // Form Submit Handler
    document.getElementById('expenseForm').addEventListener('submit', e => {
      e.preventDefault();
      
      const expense = {
        date: document.getElementById('date').value,
        category: document.getElementById('category').value,
        item: document.getElementById('item').value,
        amount: parseFloat(document.getElementById('amount').value).toFixed(2),
        notes: document.getElementById('notes').value
      };

      if (editIndex === -1) {
        expenses.push(expense);
      } else {
        expenses[editIndex] = expense;
        editIndex = -1;
        document.getElementById('submitBtn').textContent = 'Add Expense';
        document.getElementById('cancelBtn').style.display = 'none';
      }

      this.reset();
      renderExpenses();
    });

    // Edit Expense
    function editExpense(index) {
      const expense = expenses[index];
      document.getElementById('date').value = expense.date;
      document.getElementById('category').value = expense.category;
      document.getElementById('item').value = expense.item;
      document.getElementById('amount').value = expense.amount;
      document.getElementById('notes').value = expense.notes;
      editIndex = index;
      document.getElementById('submitBtn').textContent = 'Update Expense';
      document.getElementById('cancelBtn').style.display = 'inline-block';
    }

    // Cancel Edit
    function cancelEdit() {
      editIndex = -1;
      document.getElementById('expenseForm').reset();
      document.getElementById('submitBtn').textContent = 'Add Expense';
      document.getElementById('cancelBtn').style.display = 'none';
    }

    // Confirm Delete
    function confirmDelete(index) {
      if (confirm('Are you sure you want to delete this expense?')) {
        expenses.splice(index, 1);
        renderExpenses();
      }
    }

    // Export Data
    function exportData(type) {
      const data = JSON.stringify(expenses, null, 2);
      if (type === 'json') {
        const blob = new Blob([data], { type: 'application/json' });
        saveAs(blob, 'expenses.json');
      } else if (type === 'csv') {
        const csv = [
          ['Date', 'Category', 'Item', 'Amount', 'Notes'].join(','),
          ...expenses.map(e => [
            e.date,
            e.category,
            `"${e.item}"`,
            e.amount,
            `"${e.notes}"`
          ].join(','))
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        saveAs(blob, 'expenses.csv');
      }
    }

    // File Save Helper
    function saveAs(blob, filename) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // Event Listeners for Filters
    document.querySelectorAll('#startDate, #endDate, #filterCategory').forEach(element => {
      element.addEventListener('change', renderExpenses);
    });

    // Initial Render
    renderExpenses();
  </script>
</body>
</html>